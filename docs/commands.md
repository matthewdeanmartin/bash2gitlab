## Command: `compile`

### Description

The `compile` command is the core function of `bash2gitlab`. It takes a source directory containing uncompiled GitLab CI/CD YAML files, shell scripts, and variable definition files, and processes them into a final, runnable GitLab CI/CD structure in an output directory.

Its primary actions include:

  - **Inlining Scripts**: It searches for lines in your YAML files that execute local shell scripts (e.g., `bash ./scripts/deploy.sh` or `source ./utils.sh`). It reads the content of these scripts and replaces the execution line with the full script content, wrapped in a literal YAML block (`|`).
  - **Processing Variables**: It reads `global_variables.sh` and job-specific `job-name_variables.sh` files to inject CI/CD variables at the global or job level.
  - **Generating Hashes**: For each file it generates, it also creates a corresponding `.hash` file. This file contains a checksum of the generated file's content and is used by other commands like `clean` and `detect-drift` to verify file integrity.

### Workflow

The `compile` command is central to the `bash2gitlab` workflow.

1.  **`init`**: Typically, you start a project with `bash2gitlab init` to create the configuration and directory structure.
2.  **`compile`**: You then run `bash2gitlab compile` to generate the final GitLab CI/CD files from your source.
3.  **`lint`**: After compiling, you can use `bash2gitlab lint` to validate the generated YAML files against a GitLab instance.
4.  **`detect-drift`**: To ensure that no manual edits have been made to the compiled files, you can run `bash2gitlab detect-drift`, which is especially useful in a CI pipeline.
5.  **`clean`**: The `bash2gitlab clean` command can be used to remove the files generated by `compile`.
6.  **`install-precommit`**: The pre-commit hook is designed to run `compile` automatically before you commit your changes, ensuring your generated files are always up-to-date.

### Parameters

  - `--in <path>`: **(Required)** Specifies the input directory containing the source `.yml` files, scripts, and variable files.
  - `--out <path>`: **(Required)** Specifies the output directory where the compiled GitLab CI files will be written.
  - `--parallelism <int>`: The number of files to compile in parallel. Defaults to the number of CPU cores.
  - `--watch`: Enables watch mode. The command will continue running and automatically re-compile whenever a source file changes.
  - `--dry-run`: Simulates the compilation process and reports what would be changed without writing any files.
  - `-v, --verbose`: Enables detailed DEBUG level logging.
  - `-q, --quiet`: Suppresses all output except for critical errors.

### CLI Usage and Examples

```bash
# Basic compilation from 'src' to 'compiled' directory
bash2gitlab compile --in src --out compiled

# Compile with 8 parallel processes
bash2gitlab compile --in src --out compiled --parallelism 8

# Run in watch mode to automatically recompile on changes
bash2gitlab compile --in src --out compiled --watch

# Perform a dry run to see what files would be created or updated
bash2gitlab compile --in src --out compiled --dry-run
```

### Configuration (`bash2gitlab.toml`)

These settings can be specified at the top level or within a `[compile]` section.

```toml
# Top-level settings (can be overridden by the [compile] section)
input_dir = "src"
output_dir = "dist"
parallelism = 4

[compile]
# Specific settings for the compile command
input_dir = "ci-sources"
output_dir = "gitlab-ci"
watch = false
```

-----

## Command: `decompile`

### Description

The `decompile` command performs the reverse operation of `compile`. It takes one or more existing GitLab CI/CD YAML files that have inline scripts and extracts those scripts into separate `.sh` files. It also extracts `variables` blocks into corresponding `.sh` files containing `export` statements.

The original YAML file is modified to replace the inline script blocks with commands that execute the newly created external script files (e.g., `script: ./my-job.sh`). This is extremely useful for migrating an existing, monolithic `.gitlab-ci.yml` file into a `bash2gitlab`-managed project structure.

### Workflow

`decompile` is primarily a one-time utility used at the beginning of a project's migration.

1.  **`decompile`**: Run `bash2gitlab decompile` on an existing `.gitlab-ci.yml` or a directory of them. This creates a source tree of YAML templates and associated scripts.
2.  **Review**: Manually review the generated source files and organize them as needed.
3.  **`compile`**: Configure your `bash2gitlab.toml` and run `bash2gitlab compile` to verify that the decompileded source can be compiled back into a valid GitLab CI structure. The output should be functionally identical to the original file.

### Parameters

  - `--in-file <path>`: **(Required, or `--in-folder`)** Specifies a single input GitLab CI YAML file to decompile.
  - `--in-folder <path>`: **(Required, or `--in-file`)** Specifies a folder to recursively find and decompile all `*.yml` and `*.yaml` files.
  - `--out <path>`: **(Required)** The output directory where the modified YAML and new script files will be written.
  - `--dry-run`: Simulates the decompileding process without writing any files.
  - `-v, --verbose`: Enables detailed DEBUG level logging.
  - `-q, --quiet`: Suppresses all output except for critical errors.

### CLI Usage and Examples

```bash
# Decompile a single file into the 'decompileded_output' directory
bash2gitlab decompile --in-file .gitlab-ci.yml --out decompileded_output

# Decompile all YAML files in the 'existing_ci' directory
bash2gitlab decompile --in-folder existing_ci --out new_project_src

# Perform a dry run
bash2gitlab decompile --in-file .gitlab-ci.yml --out decompileded_output --dry-run
```

### Configuration (`bash2gitlab.toml`)

Settings can be specified in a `[decompile]` section.

```toml
[decompile]
input_file = ".gitlab-ci.yml"
# or
# input_folder = "ci"
output_dir = "src"
```

-----

## Command: `clean`

### Description

The `clean` command removes files generated by `bash2gitlab compile` from the output directory. It is a safe operation that will **only** delete files that were generated by `bash2gitlab` and have not been modified since they were last compiled.

It identifies these files by looking for pairs of a generated file (e.g., `job.yml`) and its corresponding hash file (`job.yml.hash`). If the content of the generated file still matches the checksum in its hash file, both files are deleted. If the content does not match (indicating a manual edit), the files are left untouched to prevent data loss.

### Workflow

The `clean` command is a utility for project maintenance.

  - It can be used before running `compile` to ensure a fresh build.
  - It helps remove generated artifacts from the working directory, for example, before committing source-only changes.

### Parameters

  - `--out <path>`: **(Required)** The output directory to clean. This should be the same directory you use for the `compile` command.
  - `--dry-run`: Simulates the cleaning process and reports which files would be deleted without actually removing them.
  - `-v, --verbose`: Enables detailed DEBUG level logging.
  - `-q, --quiet`: Suppresses all output except for critical errors.

### CLI Usage and Examples

```bash
# Clean the 'compiled' output directory
bash2gitlab clean --out compiled

# Perform a dry run to see what would be deleted
bash2gitlab clean --out compiled --dry-run
```

### Configuration (`bash2gitlab.toml`)

The `clean` command uses the global `output_dir` setting if `--out` is not provided. There is no specific `[clean]` section.

```toml
# The clean command will use this if --out is not specified
output_dir = "dist"
```

-----

## Command: `lint`

### Description

The `lint` command validates your compiled GitLab CI/CD YAML files by sending their content to a GitLab instance's CI Lint API. This allows you to catch syntax errors, logical issues, and invalid configuration before pushing your code.

It supports both the global lint endpoint and the more powerful project-scoped lint endpoint, which provides more accurate validation for pipelines that use features like `include:`, Compliance Frameworks, or project-level CI/CD variables.

### Workflow

`lint` is a validation step that is typically run after `compile`.

1.  **`compile`**: Generate your CI/CD files.
2.  **`lint`**: Run `bash2gitlab lint` against the output directory to check for errors.
3.  **Fix and Re-compile**: If errors are found, fix them in your source files and run `compile` and `lint` again.
    This cycle is crucial for maintaining valid CI/CD configurations, especially in complex projects.

### Parameters

  - `--out <path>`: **(Required)** Directory containing the compiled YAML files to be linted.
  - `--gitlab-url <url>`: **(Required)** The base URL of your GitLab instance (e.g., `https://gitlab.com`).
  - `--token <token>`: A GitLab Personal Access Token or CI\_JOB\_TOKEN for authentication. Required for private projects.
  - `--project-id <id>`: The ID of a project in GitLab to use for project-scoped linting. This provides more accurate results.
  - `--ref <ref>`: A Git ref (branch, tag) to use when linting in a project context.
  - `--include-merged-yaml`: When using project-scoped lint, requests that GitLab return the fully merged YAML, which can be useful for debugging.
  - `--parallelism <int>`: The maximum number of concurrent requests to send to the GitLab API.
  - `--timeout <float>`: The HTTP request timeout in seconds.
  - `--dry-run`, `-v`, `-q`: Common options for simulation and logging.

### CLI Usage and Examples

```bash
# Lint files in 'compiled' against gitlab.com's public linter
bash2gitlab lint --out compiled --gitlab-url https://gitlab.com

# Lint against a private project, providing a token and project ID
bash2gitlab lint --out compiled \
  --gitlab-url https://gitlab.mycompany.com \
  --token "glpat-..." \
  --project-id 1234
```

### Configuration (`bash2gitlab.toml`)

```toml
# Global output directory can be used as a default
output_dir = "dist"

[lint]
# Specific settings for the lint command
gitlab_url = "https://gitlab.com"
project_id = 12345
ref = "main"
parallelism = 4
timeout = 30.0
```

-----

## Command: `detect-drift`

### Description

The `detect-drift` command checks for manual edits in your compiled output files. It functions similarly to `clean` by comparing the content of each generated file against its `.hash` file.

However, instead of deleting matching files, `detect-drift` reports any mismatches. If a file's content has changed from what `bash2gitlab` last wrote, it will print a diff of the changes and exit with a non-zero status code. This makes it an ideal tool for CI/CD pipelines to enforce that all changes to CI/CD configuration originate from the source files, not from direct edits to the generated output.

### Workflow

`detect-drift` is primarily a CI/CD validation tool.

1.  **`compile`**: The CI pipeline begins by running `bash2gitlab compile`.
2.  **`detect-drift`**: The next step is `bash2gitlab detect-drift`. If it passes, the pipeline continues. If it fails, the pipeline stops, alerting the team that generated files were modified manually.

### Parameters

  - `--out <path>`: **(Required)** The output directory containing the generated files to check for drift.
  - `--dry-run`, `-v`, `-q`: Common options for simulation and logging.

### CLI Usage and Examples

```bash
# Check the 'compiled' directory for any manual edits
bash2gitlab detect-drift --out compiled
```

### Configuration (`bash2gitlab.toml`)

The `detect-drift` command uses the global `output_dir` setting if `--out` is not provided. There is no specific `[detect-drift]` section.

```toml
output_dir = "dist"
```

-----

## Other Commands

### `init`

  - **Description**: Starts an interactive wizard to help you create a `bash2gitlab.toml` configuration file and set up the basic directory structure for a new project.
  - **Workflow**: This is the very first command you should run when starting a new `bash2gitlab` project.
  - **Usage**: `bash2gitlab init [directory]`

### `map-deploy` & `commit-map`

  - **Description**: These commands work together to sync files between a central source and one or more target locations, typically for developing and testing shared scripts in other repositories.
      - `map-deploy`: Copies files *from* the source *to* the target directories defined in the config.
      - `commit-map`: Copies modified files *from* the target directories back *to* the source.
  - **Workflow**: A developer would `map-deploy` to a local checkout of a dependent project, test their script changes, and then `commit-map` to save those changes back to the central repository.
  - **Usage**: `bash2gitlab map-deploy`, `bash2gitlab commit-map`

### `copy2local`

  - **Description**: A utility to fetch a specific directory from a remote Git repository and place it in a local directory. It can clone via SSH or download an archive over HTTP/S.
  - **Workflow**: Useful for pulling in a shared library of scripts from another repository before running the `compile` command.
  - **Usage**: `bash2gitlab copy2local --repo-url <url> --branch <branch> --source-dir <path> --copy-dir <path>`

### `install-precommit` & `uninstall-precommit`

  - **Description**: Manages a Git pre-commit hook that automatically runs `bash2gitlab compile` before you make a commit. This ensures your compiled files are always in sync with your source.
  - **Workflow**: A developer tool to automate the compilation step. Run `install-precommit` once per repository clone.
  - **Usage**: `bash2gitlab install-precommit`, `bash2gitlab uninstall-precommit`

### `doctor`

  - **Description**: Runs a series of health checks on your project's configuration, directory structure, and environment to help diagnose problems. It checks for things like missing directories, unreferenced source files, or stray files in the output directory.
  - **Workflow**: A debugging utility to run when you encounter unexpected behavior.
  - **Usage**: `bash2gitlab doctor`

### `graph`

  - **Description**: Analyzes your project's source files and generates a dependency graph in the DOT language. This graph visualizes how your YAML files include scripts and how those scripts `source` other scripts.
  - **Workflow**: An analysis tool to help understand the structure and complexity of a large `bash2gitlab` project.
  - **Usage**: `bash2gitlab graph --in src`

### `show-config`

  - **Description**: Displays the current configuration that `bash2gitlab` is using. It shows the final resolved values for all settings and indicates their source (e.g., environment variable, `bash2gitlab.toml`, or default).
  - **Workflow**: A debugging utility for troubleshooting configuration issues.
  - **Usage**: `bash2gitlab show-config`