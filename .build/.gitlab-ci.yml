# DO NOT EDIT
# This is a compiled file, compiled with bash2gitlab
# Recompile instead of editing this file.
#
# Compiled with the command: 
#     bash2gitlab compile --in .src --out .build

# Simple GitLab pipeline using uv. All bash is inlined; no Makefile logic.

# Stages: test (lint, mypy, pytest), security (bandit), docs (checks & build), build (package), release (manual publish)


image: python:3.11-slim

variables:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  UV_LINK_MODE: copy
  UV_PROJECT_ENVIRONMENT: .venv
  UV_CACHE_DIR: .uv
  PACKAGE_DIR: bash2gitlab
stages:
- test
- security
- docs
- build
- release

# Shared setup to avoid duplication

before_script:
- |-
  set -euo pipefail
  apt-get update -y && apt-get install -y --no-install-recommends curl git ca-certificates && rm -rf /var/lib/apt/lists/*
  curl -LsSf https://astral.sh/uv/install.sh | sh -s -- -y

  export PATH="$HOME/.local/bin:$PATH"
  uv --version
  uv sync --all-extras --dev
cache:
  key:
    files:
    - pyproject.toml
    - uv.lock
  paths:
  - .venv/
  - .uv/
  - .cache/

# ------------------------

# TEST STAGE

# ------------------------


lint:
  stage: test
  script: |-
    # >>> BEGIN inline: lint.sh

    if [[ "${CI:-}" == "" ]]; then
    export PIP_DISABLE_PIP_VERSION_CHECK="1"
    export UV_LINK_MODE="copy"
    export UV_PROJECT_ENVIRONMENT=".venv"
    export UV_CACHE_DIR=".uv"
    export PACKAGE_DIR="bash2gitlab"
    fi

    uv run ruff format .
    uv run ruff check --fix .
    uv run pylint "$PACKAGE_DIR" --fail-under 9.8
    # <<< END inline
  allow_failure: false

mypy:
  stage: test
  script: |-
    # >>> BEGIN inline: mypy.sh

    if [[ "${CI:-}" == "" ]]; then
    export PIP_DISABLE_PIP_VERSION_CHECK="1"
    export UV_LINK_MODE="copy"
    export UV_PROJECT_ENVIRONMENT=".venv"
    export UV_CACHE_DIR=".uv"
    export PACKAGE_DIR="bash2gitlab"
    fi

    uv run mypy "$PACKAGE_DIR" --ignore-missing-imports --check-untyped-defs
    # <<< END inline
precommit:
  stage: test
  script: |-
    # >>> BEGIN inline: precommit.sh

    if [[ "${CI:-}" == "" ]]; then
    export PIP_DISABLE_PIP_VERSION_CHECK="1"
    export UV_LINK_MODE="copy"
    export UV_PROJECT_ENVIRONMENT=".venv"
    export UV_CACHE_DIR=".uv"
    export PACKAGE_DIR="bash2gitlab"
    fi

    uv run pre-commit run --all-files
    # <<< END inline
pytest:
  stage: test
  needs: ["lint"]
  script: |-
    # >>> BEGIN inline: pytest.sh

    if [[ "${CI:-}" == "" ]]; then
    export PIP_DISABLE_PIP_VERSION_CHECK="1"
    export UV_LINK_MODE="copy"
    export UV_PROJECT_ENVIRONMENT=".venv"
    export UV_CACHE_DIR=".uv"
    export PACKAGE_DIR="bash2gitlab"
    fi

    uv run pytest test -vv \
    --cov="$PACKAGE_DIR" --cov-branch \
    --cov-report=xml --cov-report=html \
    --cov-fail-under=48 \
    --junitxml=junit.xml -o junit_family=legacy \
    --timeout=5 --session-timeout=600
    # <<< END inline
  artifacts:
    when: always
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
    - htmlcov/
    - coverage.xml

# ------------------------

# SECURITY STAGE

# ------------------------


bandit:
  stage: security
  script: |-
    # >>> BEGIN inline: bandit.sh

    if [[ "${CI:-}" == "" ]]; then
    export PIP_DISABLE_PIP_VERSION_CHECK="1"
    export UV_LINK_MODE="copy"
    export UV_PROJECT_ENVIRONMENT=".venv"
    export UV_CACHE_DIR=".uv"
    export PACKAGE_DIR="bash2gitlab"
    fi

    uv run bandit "$PACKAGE_DIR" -r --quiet
    # <<< END inline
check_docs:
  stage: docs
  script: |-
    # >>> BEGIN inline: check_docs.sh

    if [[ "${CI:-}" == "" ]]; then
    export PIP_DISABLE_PIP_VERSION_CHECK="1"
    export UV_LINK_MODE="copy"
    export UV_PROJECT_ENVIRONMENT=".venv"
    export UV_CACHE_DIR=".uv"
    export PACKAGE_DIR="bash2gitlab"
    fi

    uv run interrogate "$PACKAGE_DIR" --verbose --fail-under 70
    set -o pipefail
    uv run pydoctest --config .pydoctest.json | grep -v "__init__" | grep -v "__main__" | grep -v "Unable to parse"
    uv run linkcheckMarkdown README.md
    uv run mdformat README.md docs/*.md
    uv run codespell README.md "$PACKAGE_DIR" docs --ignore-words=private_dictionary.txt
    # Spelling via pylint (non-fatal)
    uv run pylint "$PACKAGE_DIR" --enable C0402 --rcfile=.pylintrc_spell || true
    uv run pylint docs --enable C0402 --rcfile=.pylintrc_spell || true
    uv run changelogmanager validate || true
    # <<< END inline
build_docs:
  stage: docs
  script: |-
    # >>> BEGIN inline: build_docs.sh

    if [[ "${CI:-}" == "" ]]; then
    export PIP_DISABLE_PIP_VERSION_CHECK="1"
    export UV_LINK_MODE="copy"
    export UV_PROJECT_ENVIRONMENT=".venv"
    export UV_CACHE_DIR=".uv"
    export PACKAGE_DIR="bash2gitlab"
    fi

    uv run pdoc "$PACKAGE_DIR" --html -o docs --force
    # <<< END inline
  artifacts:
    paths:
    - docs/

# ------------------------

# BUILD STAGE

# ------------------------


build_package:
  stage: build
  script: |-
    # >>> BEGIN inline: build_package.sh

    if [[ "${CI:-}" == "" ]]; then
    export PIP_DISABLE_PIP_VERSION_CHECK="1"
    export UV_LINK_MODE="copy"
    export UV_PROJECT_ENVIRONMENT=".venv"
    export UV_CACHE_DIR=".uv"
    export PACKAGE_DIR="bash2gitlab"
    fi

    rm -rf dist
    uv run hatch build
    # <<< END inline
  artifacts:
    paths:
    - dist/

# ------------------------

# RELEASE STAGE (manual)

# ------------------------


publish_pypi:
  stage: release
  needs: ["build_package"]
  rules:
  - if: "$CI_COMMIT_TAG"
    when: manual
  - when: never
  script: |-
    # >>> BEGIN inline: publish_pypi.sh

    if [[ "${CI:-}" == "" ]]; then
    export PIP_DISABLE_PIP_VERSION_CHECK="1"
    export UV_LINK_MODE="copy"
    export UV_PROJECT_ENVIRONMENT=".venv"
    export UV_CACHE_DIR=".uv"
    export PACKAGE_DIR="bash2gitlab"
    fi

    exit 0
    # <<< END inline